{
  "run": [
    {
      "harden": "ssh"
    },
    {
      "harden": "ssh-keygen"
    },
    {
      "declare": "loc",
      "type": "map"
    },
    {
      "declare": "project",
      "type": "map"
    },
    {
      "set": "loc",
      "key": "image",
      "value": "local${sep[image]}"
    },
    {
      "set": "project",
      "key": "container",
      "value": "${runner_name}${sep[container]}"
    },
    {
      "set": "project",
      "key": "image",
      "value": "${runner_name}${sep[image]}"
    },
    {
      "set": "version",
      "key": "alpine",
      "value": "3.21"
    },
    {
      "readonly": "loc"
    },
    {
      "readonly": "project"
    },
    {
      "if": {
        "not": {
          "image": {
            "tag": {
              "defined": {
                "image": "${loc[image]}alpine",
                "tag": "${version[alpine]}"
              }
            }
          }
        }
      },
      "then": [
        {
          "image": {
            "pull": {
              "registry": "docker.io",
              "library": "library",
              "image": "alpine",
              "tag": "${version[alpine]}"
            }
          }
        },
        {
          "image": {
            "prune": {
              "matching": "${loc[image]}alpine${sep[tag]}*"
            }
          }
        },
        {
          "image": {
            "tag": {
              "create": {
                "from": {
                  "image": "alpine",
                  "tag": "${version[alpine]}"
                },
                "to": {
                  "image": "${loc[image]}alpine",
                  "tag": "${version[alpine]}"
                }
              }
            }
          }
        },
        {
          "image": {
            "remove": {
              "image": "alpine",
              "tag": "${version[alpine]}"
            }
          }
        }
      ]
    },
    {
      "declare": "ssh_home",
      "type": "string"
    },
    {
      "set": "ssh_home",
      "value": "/home/${buildargs[USER]}/.ssh"
    },
    {
      "readonly": "ssh_home"
    },
    {
      "image": {
        "build": {
          "image": "${project[image]}bounce",
          "context": "./dockerfiles/bounce",
          "args": {
            "FROM": "${loc[image]}alpine${sep[tag]}${version[alpine]}",
            "KEY_NAME": "host2lab",
            "USER": "${usr}",
            "SSH_HOME": "${ssh_home}",
            "UID": "${uid}"
          }
        }
      }
    },
    {
      "set": "path",
      "key": "bounce_ssh_key",
      "value": "${buildargs[SSH_HOME]}/${buildargs[KEY_NAME]}"
    },
    {
      "set": "path",
      "key": "ssh_home",
      "value": "${ssh_home}"
    },
    {
      "readonly": "path"
    }
  ]
}
