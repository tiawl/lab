name: lab
import:
- images/base/pull.yml
- images/bounce/build.yml
- containers/bounce/up.yml
- networks/ssh/create.yml
inventory:
  bounce_base:
  - key:
    - literal: image
    var: loc
  - literal: alpine
  - key:
    - literal: tag
    special: sep
  - key:
    - literal: alpine
    var: version
  bounce_buildargs:
  - key:
    - literal: FROM
    value:
      inventory: bounce_base
  - key:
    - literal: KEY_NAME
    value:
    - var: key_name
  - key:
    - literal: USER
    value:
    - special: USER
  - key:
    - literal: SSH_HOME
    value:
    - var: ssh_home
  - key:
    - literal: UID
    value:
    - special: UID
group:
  commands:
  - harden:
      command:
      - literal: ssh
  - harden:
      command:
      - literal: ssh-keygen
      as:
      - literal: ssh_keygen
  - assign:
      vars:
      - - literal: ssh_home
      - - literal: key_name
      - - literal: bounce_ip
      - - literal: bounce_tag
      scope: local
  - assign:
      vars:
      - - literal: instance_counter
      - - literal: bounce_theme
      scope: global
  - assign:
      vars:
      - - literal: loc
      - - literal: project
      - - literal: version
      - - literal: path
      type: associative
      scope: local
  - define:
      name: new_instance_theme
      group:
        commands:
        - assign:
            vars:
            - - literal: output
            scope: local
        - register:
            into:
              var: instance_counter
            arithmetic:
              addition:
                left:
                  var: instance_counter
                  default:
                  - number: -1
                right:
                  number: 1
        - color:
            index:
            - var: instance_counter
            ref:
            - literal: output
        - print:
            format: '%s'
            args:
            - - var: output
  - mutate:
      name:
        var: loc
      key:
      - literal: image
      value:
      - - literal: local
        - key:
          - literal: image
          special: sep
  - mutate:
      name:
        var: project
      key:
      - literal: container
      value:
      - - special: RUNNER
        - key:
          - literal: container
          special: sep
  - mutate:
      name:
        var: project
      key:
      - literal: network
      value:
      - - special: RUNNER
        - key:
          - literal: network
          special: sep
  - mutate:
      name:
        var: project
      key:
      - literal: image
      value:
      - - special: RUNNER
        - key:
          - literal: image
          special: sep
  - mutate:
      name:
        var: version
      key:
      - literal: alpine
      value:
      - - literal: "3.22"
  - readonly:
    - - literal: loc
    - - literal: project
  - runner:
      exec:
        imported: images/base/pull.yml
  - mutate:
      name:
        var: ssh_home
      value:
      - - literal: /home/
        - special: USER
        - literal: /.ssh
  - mutate:
      name:
        var: key_name
      value:
      - - literal: host2lab
  - readonly:
    - - literal: ssh_home
    - - literal: key_name
  - runner:
      exec:
        imported: images/bounce/build.yml
  - mutate:
      name:
        var: path
      key:
      - literal: bounce_ssh_key
      value:
      - - var: ssh_home
        - literal: /
        - var: key_name
  - mutate:
      name:
        var: path
      key:
      - literal: ssh_home
      value:
      - - var: ssh_home
  - readonly:
    - - literal: path
  - runner:
      exec:
        imported: networks/ssh/create.yml
  - runner:
      exec:
        imported: containers/bounce/up.yml
  - defer:
      image:
        builder:
          prune: true
  - defer:
      container:
        stop:
          name:
          - var: project
            key:
            - literal: container
          - literal: bounce
  - register:
      group:
        commands:
        - network:
            ip:
              get:
                container:
                - var: project
                  key:
                  - literal: container
                - literal: bounce
                network:
                - var: project
                  key:
                  - literal: network
                - literal: ssh
      into:
        var: bounce_ip
  - readonly:
    - - literal: bounce_ip
  - call:
      command: ssh_keygen
      args:
      - - literal: -R
      - - var: bounce_ip
  - call:
      command: ssh
      args:
      - - literal: -i
      - - var: path
          key:
          - literal: ssh_home
        - literal: /
        - var: key_name
      - - special: USER
        - literal: '@'
        - var: bounce_ip
      - - literal: '"echo \"export THEME='
        - var: bounce_theme
        - literal: '\" >> /etc/profile.d/10theme.sh"'
  - call:
      command: ssh
      args:
      - - literal: -i
      - - var: path
          key:
          - literal: ssh_home
        - literal: /
        - var: key_name
      - - special: USER
        - literal: '@'
        - var: bounce_ip
