group:
  commands:
  - harden:
      command:
      - literal: ssh
  - harden:
      command:
      - literal: ssh-keygen
      as:
      - literal: ssh_keygen
  - assign:
      vars:
      - - literal: ssh_home
      - - literal: key_name
      - - literal: bounce_ip
      scope: local
  - assign:
      vars:
      - - literal: loc
      - - literal: project
      - - literal: version
      - - literal: path
      type: associative
      scope: local
  - mutate:
      name:
        var: loc
      key:
      - literal: image
      value:
      - - literal: local
        - key:
          - literal: image
          special: sep
  - mutate:
      name:
        var: project
      key:
      - literal: container
      value:
      - - special: RUNNER
        - key:
          - literal: container
          special: sep
  - mutate:
      name:
        var: project
      key:
      - literal: image
      value:
      - - special: RUNNER
        - key:
          - literal: image
          special: sep
  - mutate:
      name:
        var: version
      key:
      - literal: alpine
      value:
      - - literal: "3.21"
  - readonly:
    - - literal: loc
    - - literal: project
  - if:
      not:
        group:
          commands:
          - image:
              tag:
                defined:
                  image:
                  - key:
                    - literal: image
                    var: loc
                  - literal: alpine
                  tag:
                  - key:
                    - literal: alpine
                    var: version
      group:
        commands:
        - image:
            pull:
              image:
              - literal: alpine
              library:
              - literal: library
              registry:
              - literal: docker.io
              tag:
              - key:
                - literal: alpine
                var: version
        - image:
            prune:
              matching:
              - key:
                - literal: image
                var: loc
              - literal: alpine
              - key:
                - literal: tag
                special: sep
              - literal: '*'
        - image:
            tag:
              create:
                from:
                  image:
                  - literal: alpine
                  tag:
                  - key:
                    - literal: alpine
                    var: version
                to:
                  image:
                  - key:
                    - literal: image
                    var: loc
                  - literal: alpine
                  tag:
                  - key:
                    - literal: alpine
                    var: version
        - image:
            remove:
              image:
              - literal: alpine
              tag:
              - key:
                - literal: alpine
                var: version
  - mutate:
      name:
        var: ssh_home
      value:
      - - literal: /home/
        - special: USER
        - literal: /.ssh
  - mutate:
      name:
        var: key_name
      value:
      - - literal: host2lab
  - readonly:
    - - literal: ssh_home
    - - literal: key_name
  - image:
      build:
        args:
        - key:
          - literal: FROM
          value:
          - key:
            - literal: image
            var: loc
          - literal: alpine
          - key:
            - literal: tag
            special: sep
          - key:
            - literal: alpine
            var: version
        - key:
          - literal: KEY_NAME
          value:
          - var: key_name
        - key:
          - literal: USER
          value:
          - special: USER
        - key:
          - literal: SSH_HOME
          value:
          - var: ssh_home
        - key:
          - literal: UID
          value:
          - special: UID
        context:
        - literal: ./dockerfiles/bounce
        image:
        - key:
          - literal: image
          var: project
        - literal: bounce
  - mutate:
      name:
        var: path
      key:
      - literal: bounce_ssh_key
      value:
      - - var: ssh_home
        - literal: /
        - var: key_name
  - mutate:
      name:
        var: path
      key:
      - literal: ssh_home
      value:
      - - var: ssh_home
  - readonly:
    - - literal: path
  - container:
      create:
        name:
        - var: project
          key:
          - literal: container
        - literal: bounce
        image:
        - var: project
          key:
          - literal: image
        - literal: bounce
        hostname:
        - literal: bounce
  - defer:
      image:
        builder:
          prune: true
  - container:
      resource:
        copy:
          name:
          - var: project
            key:
            - literal: container
          - literal: bounce
          src:
          - var: path
            key:
            - literal: bounce_ssh_key
          dest:
          - var: path
            key:
            - literal: ssh_home
  - container:
      resource:
        copy:
          name:
          - var: project
            key:
            - literal: container
          - literal: bounce
          src:
          - var: path
            key:
            - literal: bounce_ssh_key
          - literal: .pub
          dest:
          - var: path
            key:
            - literal: ssh_home
  - container:
      start:
        name:
        - var: project
          key:
          - literal: container
        - literal: bounce
  - defer:
      container:
        stop:
          name:
          - var: project
            key:
            - literal: container
          - literal: bounce
  - register:
      group:
        commands:
        - network:
            ip:
              get:
                container:
                - var: project
                  key:
                  - literal: container
                - literal: bounce
      into:
        var: bounce_ip
  - readonly:
    - - literal: bounce_ip
  - call:
      command: ssh_keygen
      args:
      - - literal: -R
      - - var: bounce_ip
  - call:
      command: ssh
      args:
      - - literal: -i
      - - var: path
          key:
          - literal: ssh_home
        - literal: /
        - var: key_name
      - - special: USER
        - literal: '@'
        - var: bounce_ip
